---
import { Box, Grid, Link, List, ListItem, ListItemButton } from "@mui/joy";
import { type Languages, defaultLang } from "../../i18n/ui";
import {
  getRoutePathWithLang,
  isUIKey,
  useSharedTranslations,
} from "../../i18n/utils";
import { STATIC_ROUTES } from "../../utils/staticRoute";
import { Typography } from "../Typography";
import { LangSelectorWithTheme } from "./Header/LangSelectorWithTheme";
import { SimpleMobileMenu } from "./Header/SimpleMobileMenu";

type Props = {
  lang: Languages;
  currentPathWithoutLang: string;
  title: string;
  keepOpen?: boolean;
};

const { lang, currentPathWithoutLang = "/", title, keepOpen } = Astro.props;
const t = useSharedTranslations(lang);
---

<!-- 静的ヘッダー（サーバーレンダリング） -->
<header>
  <Box component="nav" aria-label="My site">
    <List role="menubar" orientation="horizontal" sx={{ padding: "0px" }}>
      <ListItem
        sx={{
          padding: "2px",
        }}
      >
        <Link
          aria-label="to Home"
          underline="none"
          href={lang === defaultLang ? "/" : `/${lang}`}
        >
          <Typography level="h1">{t("header")}</Typography>
        </Link>
      </ListItem>

      <!-- デスクトップ用メニュー（静的） -->
      {STATIC_ROUTES.map((route, index) => {
        const uiKey = `route.${route}`;
        if (!isUIKey(lang, uiKey)) return null;
        const routePath = getRoutePathWithLang(route, lang);
        return (
          <ListItem
            key={route}
            sx={{
              display: { xs: "none", sm: "flex" },
              marginInlineStart: index === 0 ? "auto" : "unset",
            }}
          >
            <ListItemButton
              role="menuitem"
              component="a"
              href={routePath}
              selected={currentPathWithoutLang === `/${route}`}
            >
              {t(uiKey)}
            </ListItemButton>
          </ListItem>
        );
      })}

      <!-- モバイル用メニューボタン（Pure HTML/CSS） -->
      <ListItem
        sx={{
          marginInlineStart: { xs: "auto", sm: "0" },
          display: { xs: "flex", sm: "none" },
          padding: "unset",
        }}
      >
        <div style="position: relative;">
          <button 
            type="button"
            style="background: none; border: none; padding: 12px; cursor: pointer; font-size: 24px;"
            onclick="
              const dropdown = this.nextElementSibling;
              dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            "
            aria-label="メニューを開く"
          >
            ⋮
          </button>
          <div 
            style="
              display: none;
              position: absolute;
              top: 100%;
              right: 0;
              background-color: white;
              border: 1px solid #ccc;
              border-radius: 4px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              min-width: 150px;
              z-index: 1000;
            "
          >
            {STATIC_ROUTES.map((route) => {
              const uiKey = `route.${route}`;
              const routePath = getRoutePathWithLang(route, lang);
              if (isUIKey(lang, uiKey)) {
                return (
                  <a
                    href={routePath}
                    style={{
                      display: "block",
                      padding: "12px 16px",
                      textDecoration: "none",
                      color: "black",
                      borderBottom: "1px solid #eee",
                      backgroundColor: currentPathWithoutLang === `/${route}` ? "#f0f0f0" : "transparent",
                    }}
                  >
                    {t(uiKey)}
                  </a>
                );
              }
              return null;
            })}
          </div>
        </div>
      </ListItem>

      <!-- 言語切り替えボタン（クライアントハイドレーション） -->
      <ListItem
        sx={{
          padding: "5px",
          borderRadius: "0%",
        }}
      >
        <LangSelectorWithTheme
          path={currentPathWithoutLang}
          currentLang={lang}
          client:visible
        />
      </ListItem>
    </List>
  </Box>
</header>

<main>
  <!-- PageCover（静的） -->
  <Box
    sx={{
      textAlign: "center",
    }}
  >
    <Grid container spacing={2} sx={{ flexGrow: 1 }}>
      <Grid xs={12}>
        <Box
          height={{
            xs: "6rem",
            sm: "8rem",
            md: "10rem",
          }}
          sx={{
            alignContent: "center",
          }}
        >
          <Typography level="h1">{title}</Typography>
        </Box>
      </Grid>
    </Grid>
  </Box>

  <!-- メインコンテンツ（静的） -->
  <slot />
</main>
{/* TODO: footer */}